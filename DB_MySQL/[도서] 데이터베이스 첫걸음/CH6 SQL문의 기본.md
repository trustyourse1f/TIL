# 6장 SQL문의 기본
1개의 데이터베이스에는 복수의 테이블이 저장되어 있다.  
MySQL의 경우 데이터베이스를 살펴보려면 show databases;  
디폴트(현재) 데이터베이스를 지정하려면 use 데이터베이스명;  
데이터베이스 내의 테이블 리스트를 얻을 때는 show tables; 명령을 사용한다.  
여기서 show나 use는 SQL이 아니고 관리 명령이다.  

## SELECT문
```
SELECT 열명 FROM 테이블명;
```
열명에 *를 사용하면 'FROM 테이블명'에서 지정한 테이블의 전체 열을 지정할 수 있고, 임의의 열을 ,로 구분해 복수로 지정하는 것도 가능하다.  
테이블명은 표 자체의 이름을 사용하거나 암묵적으로 디폴트 데이터베이스의 테이블을 지정하는 것도 가능하며, 명시적으로 '데이터베이스명.테이블명'형태로도 지정할 수 있다.  
명령|설명
-|-
select * from city;|디폴트 데이터베이스의 city를 SELECT한다.
select * from world.city;|'데이터베이스명.테이블명'형태로 명시적으로 world 데이터베이스의 city를 SELECT한다.

### WHERE 조건이 필요한 이유
데이터베이스의 테이블에서 열의 수는 테이블을 정의했을 때 결정되어 이후 명시적으로 변경하지 않는 한 늘어나지 않는다. 하지만 행수는 제한없이 늘릴 수 있다. 따라서 필요한 데이터를 효율성있게 클라이언트로 가져오기 위해서도 SELECT하는 행수를 줄여야 한다. 이럴 경우에 WHERE 구문을 지정해 'WHERE 조건'의 형태로 SELECT문의 끝에 추가한다.
```
SELECT 열명 FROM 테이블명 WHERE 조건;
```
조건은 테이블의 각 행을 살펴보고 일치하는 행만 SELECT한다. 조건에는 비교 연산자 'AND'와 OR'이 자주 사용된다.  

연산자 우선순위는 생략

### DISTINCT에 의한 중복 배제
선택한 행에서 중복된 값이 있고 이를 없애고 싶은 경우에는 'DISTINCT' 키워드를 지정한다.  
예 : 
```
SELECT DISTINCT District from city where CountryCode = 'KOR';
```

### 검색결과 정렬
열의 순서는 SELECT 열1, 열2, ... 와 같이 명시적으로 지정하지 않는 한 표를 작성할 떄의 순서대로 된다.  
행의 순서는 'ORDER BY'란 명령으로 지정해야 한다. 
```
SELECT ~ ORDER BY 열1[, 열2, ...]
```
내림차순으로 정렬할 때는 DESC 키워드를 추가한다.  
예 : 
```
SELECT * FROM city WHERE CountryCode = 'KOR' ORDER BY Population DESC;
```
> 정렬 수행 시 주의할 점  

ORDER BY에 의한 정렬을 수행할 때 행의 순서를 확실히 같게 하려면 행의 정렬키를 한 가지 의미(Unique)로 정해야 한다. 정렬키가 같은 값의 행이 복수 개 존재한다면 그 행들의 순서는 일정하지 않다.  

### 테이블을 요약하는 함수
SQL에서 데이터에 의해 어떠한 조작이나 계산을 수행하려면 '함수'라는 도구를 사용한다. 함수에는 크게 나누어 다음 2종류가 있다.  
- 복수 행(이나 행의 값)에 대해 집계를 수행하는 함수
- 단일 행의 값에 대해 조작이나 계산을 수행하는 함수  

대표적인 집약함수 5가지  
- COUNT : 테이블의 행수를 알려주는 함수
- SUM : 테이블의 수치 데이터를 합계하는 함수
- AVG : 테이블의 수치 데이터 평균을 구하는 함수
- MAX : 테이블의 임의열 데이터 중 최대값을 구하는 함수
- MIN : 테이블의 임의열 데이터 중 최소값을 구하는 함수

### 문자열을 집약하는 GROUP_CONCAT
문자열에 대한 집약함수는 SQL 표준에는 없으나 MySQL에는 'GROUP_CONCAT'함수가 있다. GROUP_CONCAT 함수는 문자열에 대한 집계를 문자열의 결합으로 수행한다. 따라서 콤마로 구분되는 매우 긴 데이터를 결과로 돌려준다.  
예상외의 길이를 가진 결과를 돌려주는 경우가 있기 때문에 GROUP_CONCAT 함수의 결과를 저장하거나 표시하는 경우에는 주의가 필요하다. (DISTINCT로 중복을 피할 수 있다.)

### 데이터를 그룹으로 나누는 GROUP BY
대상이 되는 데이터를 몇 개의 그룹으로 나눠서 집약하는 것도 가능하다. 그룹을 나눌 때는 나누는 키가 되는 열을 지정한다.
```
SELECT ~ FROM 테이블명 GROUP BY 열명1 [, 열명2, ...]
```
GROUP BY로 지정한 열을 '집약 키'나 '그룹화 키'로 부르며 이들은 ORDER BY처럼 복수 열을 콤마로 구분해 지정할 수 있다.  

> 나눈 그룹에 조건 추가

그룹으로 나눠서 집약한 값(COUNT(*))에 대해 조건을 설정하기 위해 WHERE 구문에 조건을 추가하면 이 쿼리는 오류가 발생한다.  
COUNT같은 집약함수를 작성할 수 있는 경우는 SELECT와 ORDER BY, HAVING뿐이다. 조건으로 작성하려면 HAVING으로 지정해야 한다.  

> 집약한 결과에 조건 지정  

그룹마다 집약한 값을 조건으로 선택하고 싶다면 HAVING뒤에 조건을 지정한다.
```
 SELECT ~ FROM ~ GROUP BY ~ HAVING 그룹의 값에 대한 조건
```
예 :  
```
SELECT District, COUNT(*) FROM city WHERE CountryCode = 'KOR' GROUP BY District HAVING COUNT(*) = 6;
```

SELECT와 ORDER BY에도 집약함수를 기술할 수 있는데 ORDER BY로 기술하는 경우 ORDER BY 뒤에 기술한다. (ORDER BY COUNT(*) DESC)

## UPDATE문
기존 데이터를 변경(갱신)할 때는 UPDATE문을 사용한다.
```
UPDATE 테이블명 SET 열명 = 값 WHERE 조건;
```
### 복수 열의 동시 갱신
갱신은 열별로 구분해 지정(SET 열명1=값1[열명2=값2, ...])하면 복수 개의 열을 동시에 갱신할 수 있다.  
예:  
```
UPDATE city set Name = 'Siheung', Population = 429320 WHERE CountryCode = 'KOR' and District = 'Kyonggi', Name = 'Shihung';
```

## INSERT문
테이블에 데이터를 입력할 때는 INSERT문을 사용한다. INSERT는 행 단위로 수행되므로 행을 구성하는 열의 정보를 포함한 '테이블 정의'를 정확하게 알아야 한다.  
MySQL에서는 다음 명령으로 테이블 정의를 알 수 있다.
- show create table 테이블명\G
- desc 테이블명;  

INSERT문의 기본 구문은 다음과 같다.
```
INSERT INTO 테이블명(열1[, 열2, ...]) VALUES(값1[, 값2, ...]);
```
테이블명 뒤의 열 리스트와 VALUES 뒤의 값 리스트는 수와 데이터형이 일치되어야 하고 테이블에 정의된 모든 열에 대해 VALUES에서 값을 설정하면 테이블명의 열 리스트를 생략할 수 있다.(단, VALUES 뒤의 값 리스트는 테이블의 열 정의순으로 나열해야 한다.)  
예 :
```
INSERT INTO city VALUES (DEFAULT, 'Gimpo', 'KOR', 'Kyonggi', 349900);
```
### 데이터 입력에 자주 사용되는 구문
자주 사용되는 구문으로 'INSERT INTO 테이블1 SELECT * FROM 테이블2'가 있다. 이것은 VALUES 대신에 입력한 값(레코드)으로 SELECT문의 결과를 사용하는 방법이다. 이 방법을 사용하면 기존의 데이터를 통해 1행으로 복수의 레코드 입력이 가능하다.  

예:  
citycopy 테이블 작성
```
create table citycopy like city;
```
city 테이블과 동일한 데이터 입력
```
INSERT INTO citycopy SELECT * FROM city;
```
또한 MySQL에서는 INSERT문 하나로 신규 복수 행을 입력할 수 있는 '복수 행의 입력'이라는 기능이 있다.  
예 :  
```
INSERT INTO city (Name, CountryCode, District, Population) VALUES ('Gimpo', 'KOR', 'Kyonggi', 349900), ('Pocheon', 'KOR', 'Kyonggi', 155192), ('Hwaseong', 'KOR', 'Kyonggi', 613091);
```

## DELETE문
기존 데이터를 제거할 때 사용하는 DELETE문의 기본 구문은 다음과 같다.
```
DELETE FROM 테이블명 WHERE 조건;
```

## 뷰
뷰는 SQL시점에서 보면 테이블과 동일하지만 테이블과 같은 데이터는 가지고 있지 않으며 테이블에 대한 SELECT를 가지고 있다. 테이블 대신에 뷰를 사용하는 이점은 다음과 같다.
1. 복잡한 SELECT문을 일일이 매번 기술할 필요가 없다.
2. 필요한 열과 행만 사용자에게 보여줄 수 있고, 갱신 시에도 뷰 정의에 따른 갱신으로 한정할 수 있다.
3. 1과 2의 이점을 데이터 저장 없이(기억장치의 용량을 사용하지 않고) 실현할 수 있다. 또한, 뷰를 제거(DROP VIEW)해도 참조하는 테이블은 영향을 받지 않는다.

### 뷰를 작성하는 CREATE VIEW문
뷰를 작성할 떄는 CREATE VIEW문을 사용한다.
```
CREATE VIEW 뷰명 (열명1[, 열명2, ...]) AS SELECT문;
```
원래의 SELECT문에서 열 전체를 지정하는 경우에는 뷰명 뒤의 괄호와 열 리스트는 생략할 수 있다.  

### 뷰로의 입력, 갱신의 제한
뷰로의 입력과 갱신에는 몇가지 제한이 붙는다. 기본적으로 어떤 행이 대응하는지 모르거나 어떤 값을 넣을지 모르는 경우에는 갱신할 수 없다. 예를 들어, GROUP BY로 집약한 수치나 DISTINCT로 얻은 값을 갱신하는 경우에는 결과의 기반이 되는 테이블의 n행 중 어떤 수치를 갱신하는 것이 좋을 지 알 수 없다. 또한 2가지 이상의 테이블을 조합해 작성한 뷰를 갱신할 때는 어느 테이블을 갱신하면 좋을지를 알 수 없는 경우가 있다. 게다가 뷰에서 원래 테이블의 일부 열만 선택되었다면 데이터를 삽입하려고 해도 선택된 열 이외의 열에 DEFAULT 값도 없고 NULL도 허용되지 않는 상황에서는 해당 열에 넣을 수 있는 값이 없어서 실질적으로 뷰로의 삽입은 불가능하다.

## 서브쿼리
통상적으로 SELECT문의 결과는 택한 열과 행으로 구성된 테이블 형식이다. 그 특수한 형태로 하나의 열과 하나의 행으로 구성된 테이블, 즉 단일값으로 구성된 경우가 있다. SQL문에서는 이런 SELECT문의 결과를 조건문에 이용할 수 있고 이런 쿼리를 서브쿼리라고 한다.  

## 결합
SQL은 단일 테이블에만 대응하는 것이 아니라 2개 이상의 테이블을 대상으로 실행하는 것이 가능하고 이 때 결합(JOIN)이 이용된다.  
결합은 하나의 테이블에 있는 열만으로는  데이터가 충족되지 않는 경우에 열을 가지고 오는 조작이다. 결합에는 '내부결합(INNER JOIN)과 외부결합(OUTER JOIN)이 있다.

### 내부결합(INNER JOIN)
결합은 2개의 테이블에서 필요한 열을 가지고 올 때 행을 결합하기 위한 조건을 'ON'으로 지정한다. 내부결합에서는 이 ON으로 지정한 결합 조건에 일치하는 행만을 2개의 테이블로부터 가져올 수 있다.  
내부결합의 형식은 다음과 같다.   
```
SELECT 선택하고 싶은 열 리스트 FROM 첫 번째 테이블명 INNER JOIN 두 번째 테이블 명 ON 결합 조건;
```
예 :  
```
SELECT countrylanguage.*, country.name FROM countrylanguage INNER JOIN country ON countrylanguage.CountryCode = country.code WHERE Language = 'Korean';
```
여기서는 결합 조건으로 CountryCode, countrylanguage테이블에서 모든 열(*), country테이블에서 name열을 가져오고 있다. 이처럼 2개 테이블의 열이 어느 테이블에서 온 것인지를 구별하고 싶을 때는 테이블명을 추가하여 '테이블명.열명'과 같이 지정한다.  
(한 쪽 테이블에만 존재하는 열이라면 테이블명을 생략해도 된다.  
~~테이블명~~.열명)

### 외부결합(OUTER JOIN)
내부결합은 2개의 테이블에서 결합 조건에 일치하는 것만을 얻어내지만 실무에서는 한 쪽 테이블을 기준으로 전체 행을 표시하고 다른 테이블은 값이 있으면 표시하고 싶은 경우가 자주 있다. 이런 경우 외부결합을 이용한다. 
```
SELECT 선택하고 싶은 열의 리스트 FROM 첫 번째 테이블명 LEFT OUTER JOIN 두 번째 테이블명 ON 결합 조건;
```
2개의 테이블 중 왼쪽 테이블(첫 번째 테이블)의 전체 행이 표시되고 다른 테이블의 데이터는 결합 조건과 일치할 때 그 값이 되고 일치하는 것이 없으면 NULL이 된다.