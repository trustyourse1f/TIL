# 7장 트랜잭션과 동시성 제어

## 트랜잭션
앞 장에서 테이블 갱신을 수행하기 위해 'INSERT/DELETE/UPDATE'를 사용했는데, 갱신은 단일 쿼리만으로 구성된 것이 아니고 복수 쿼리를 연속적으로 수행하는 경우가 대부분이다. 갱신 전의 데이터로 SELECT를 사용할 때 이를 포함해 복수 쿼리를 일관된 형태의 한덩어리로 다뤄야 한다. 트랜잭션이란 이런 복수 쿼리를 한 단위로 묶은 것이다.

트랜잭션은 다음 4가지 특성으로 정의되며 그 앞글자를 따서 ACID특성이라고 한다.  
1. Atomicity(원자성)
2. Consistency(일관성)
3. Isolation(고립성 또는 격리성)
4. Durability(지속성)

### 원자성
원자성이란 데이터의 변경(INSERT/DELETE/UPDATE)을 수반하는 일련의 데이터 조작이 전부 성공할지 전부 실패할지를 보증하는 구조이다.

### 일관성
데이터베이스에는 데이터베이스 오브젝트(테이블을 비롯해 데이터베이스 내에 정의할 수 있는 오브젝트)에 대해 각종 정합성 제약을 추가할 수 있다. 이는 일련의 데이터 조작 전후에 그 상태를 유지하는것을 보증하는 즉 일관성을 유지하기 위한 구조이다.

### 고립성
고립성이란 일련의 데이터 조작을 복수 사용자가 동시에 실행해도 각각의 처리가 모순없이 실행되는 것을 보증한다는 것이다.  

ANSI가 정의하는 격리수준  
1. 커밋되지 않은 읽기(가장 완화)
2. 커밋된 읽기
3. 반복 읽기
4. 직렬화 기능(가장 엄격)

격리 수준 완화에 따라 일어나는 현상
현상|개요
-|-
더티 읽기|어떤 트랜잭션이 커밋되기 전에 다른 트랜잭션에서 데이터를 읽는 현상
애매한 읽기|어떤 트랜잭션 이전에 읽어 들인 데이터를 다시 읽어 들일 때 2회 이후의 결과가 1회 때와 다른 현상
팬텀 읽기|어떤 트랜잭션을 읽을 때 선택할 수 있는 데이터가 나타나거나 사라지는 현상.

### 지속성
지속성은 일련의 데이터 조작(트랜잭션 조작)을 완료(commit)하고 완료 통지를 사용자가 받는 시점에서 그 조작이 영구적이 되어 그 결과를 잃지 않는 것을 나타낸다. 이것은 시스템이 정상일 때만이 아니라 데이터베이스나 OS의 이상 종료, 즉 시스템 장애도 견딜 수 있다는 뜻이다.

### DDL, DML, DCL
SQL문은 DBMS에 줄 수 있는 명령의 종류에 따라 다음 3가지로 구분된다.
1. 데이터 정의 언어 DDL, Data Definition Language : DDL은 데이터를 저장하는 그릇인 스키마(데이터베이스) 또는 테이블 등을 작성하거나 제거한다. DDL로 구분된 명령에는 CREATE외에 DROP, ALTER 등이 있다.
2. 데이터 조작 언어 DML, Data Manipulation Language : DML은 테이블의 행을 검색하거나 변경하는데 사용한다. DML로 구분된 명령에는 SELECT, INSERT, UPDATE, DELETE 등이 있다.
3. 데이터 제어 언어 DCL, Data Control Language : DCL은 데이터베이스에서 실행한 변경을 확정하거나 취소하는 데 사용한다. COMMIT이나 ROLLBACK은 DCL의 일종이다. **실무에서 사용하는 SQL문 대부분은 DML이다.**

## MVCC에 따른 MySQL의 특성
MySQL(InnoDB형 테이블)은 MVCC(Multi Versioning Concurrency Control)라는 기술을 사용하고 있다. MVCC를 사용하기 때문에 MySQL은 다음과 같은 특성을 가진다.
1. 읽기를 수행할 경우 갱신 중이라도 블록되지 않는다(읽기와 읽기도 서로 블록되지 않는다.)
2. 읽기 내용은 격리 수준에 따라 내용이 바뀌는 경우가 있다.
3. 갱신 시 배타적 잠금을 얻는다. 잠금은 기본적으로 행 단위로 얻으며 트랜잭션이 종료할 때까지 유지한다. 격리수준이나 InnoDB의 설정에 따라 실제로 잠금 하는 행의 범위가 다른 경우가 있다.
4. 갱신과 갱신은 나중에 온 트랜잭션이 잠금을 획득하려고 할 때 블록된다. 일정시간을 기다리며 그사이에 잠금을 획득할 수 없는 경우에는 잠금 타임아웃(Lock Timeout)이 된다.
5. 갱신하는 경우 갱신 전의 데이터를 UNDO 로그로 '롤백 세그먼트'라는 영역에 유지한다. 이 UNDO 로그는 용도가 2가진데 첫 번째는 갱신하는 트랜잭션의 롤백 시 갱신 전으로 되돌리는 것이고, 두 번째는 복수의 트랜잭션으로부터 격리 수준에 따라 대응하는 갱신 데이터를 참조하는 데 이용한다.

MySQL  트랜잭션 격리 수준의 기본값은 반복 읽기(RR, Repeatable Read)이다.
## 반복 읽기
반복 읽기는 최초 쿼리를 실행한 시점에서 커밋된 데이터를 읽어 들인다. 이 시점에서는 커밋된 읽기와 같다. 같은 쿼리를 복수 회 실행하면 최초 읽은 내용의 결과 세트가 반환된다. 복수 회의 쿼리 실행 사이에 다른 트랜잭션이 커밋했어도 그 내용은 반영되지 않는다.

## 커밋된 읽기
커밋된 읽기는 쿼리를 실행한 시점에서 데이터를 읽어 들인다. 같은 쿼리를 복수 회 실행하면 그사이에 다른 트랜잭션에서 커밋할 때가 있는데, 이 경우 최신 쿼리의 실행 개시 시점에서 커밋된 데이터를 읽는다.

## 오토커밋
MySQL에서는 새로운 연결은 모두 기본값으로 오토커밋이 실행된다. 오토커밋이란 쿼리 단위로 커밋하는 설정인데 주의해서 사용하지 않으면 트랜잭션의 혜택을 받지 못할뿐더러 성능에 악영향을 미친다.